<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自定义表达式内函数 | Era 中文文档</title>
    <meta name="description" content="Eramaker + Emuera + Erabasic 中文文档">
    <link rel="stylesheet" href="/Era-Chinese-Documentation/assets/style.cac40d77.css">
    <link rel="modulepreload" href="/Era-Chinese-Documentation/assets/Home.09e83101.js">
    <link rel="modulepreload" href="/Era-Chinese-Documentation/assets/app.0c072424.js">
    <link rel="modulepreload" href="/Era-Chinese-Documentation/assets/translation_Custom_Expression.md.ee442b36.lean.js">
    <link rel="modulepreload" href="/Era-Chinese-Documentation/assets/app.0c072424.js">
    <meta name="twitter:title" content="自定义表达式内函数 | Era 中文文档">
    <meta property="og:title" content="自定义表达式内函数 | Era 中文文档">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/Era-Chinese-Documentation/" aria-label="Era 中文文档, back to home" data-v-675d8756 data-v-4a583abe><!----> Era 中文文档</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/guide/" data-v-b8818f8c>指南 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/reference/" data-v-b8818f8c>参考 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/translation/" data-v-b8818f8c>翻译 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/development/" data-v-b8818f8c>开发 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/ecosystem/" data-v-b8818f8c>生态 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/contribute/" data-v-b8818f8c>贡献 <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/guide/" data-v-b8818f8c>指南 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/reference/" data-v-b8818f8c>参考 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/translation/" data-v-b8818f8c>翻译 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/development/" data-v-b8818f8c>开发 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/ecosystem/" data-v-b8818f8c>生态 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/Era-Chinese-Documentation/contribute/" data-v-b8818f8c>贡献 <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#格式">格式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#限制条件">限制条件</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#不能从call中调用">不能从CALL中调用</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#有些指令是不可用的">有些指令是不可用的</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#不支持函数重载">不支持函数重载</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#覆盖内置函数">覆盖内置函数</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#注意事项">注意事项</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#短路逻辑导致调用省略">短路逻辑导致调用省略</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#其结果取决于方程的评估顺序">其结果取决于方程的评估顺序</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#可由调试函数调用">可由调试函数调用</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="自定义表达式内函数" tabindex="-1">自定义表达式内函数 <a class="header-anchor" href="#自定义表达式内函数" aria-hidden="true">#</a></h1><blockquote><p>翻译自原文档：<a href="https://osdn.net/projects/emuera/wiki/UserMeth" target="_blank" rel="noopener noreferrer">https://osdn.net/projects/emuera/wiki/UserMeth</a></p></blockquote><p>表达式内函数，即除了内置函数之外，还可以在表达式中调用<code>@~~</code>中定义的函数。</p><p>关于表达式内函数的更多信息，<a href="./.html">请参见表达式内函数</a>。</p><h2 id="格式" tabindex="-1">格式 <a class="header-anchor" href="#格式" aria-hidden="true">#</a></h2><p>被调用的函数必须有<code>#FUNCTION</code>或<code>#FUNCTIONS</code>标志，并且必须以<code>RETURNF</code>结束。</p><p><code>#FUNCTION</code>表示该函数返回一个数字。</p><p><code>#FUNCTION(S)</code>：返回一个字符串。</p><p>一个带有<code>#FUNCTION(S)</code>的函数不能用通常的<code>RETURN</code>来终止。 相反，它们是以<code>RETURNF</code>终止的。</p><p><code>RETURNF</code>可以是一个公式或一个字符串表达式。 它必须符合<code>#FUNCTION(S)</code>中给出的类型。</p><p>如果省略<code>RETURNF</code>参数，或者在没有<code>RETURNF</code>的情况下到达函数的终点，则返回<code>0</code>或<code>&quot;&quot;</code>。</p><div class="language-"><pre><code>X = GET_CFLAG(TARGET, Y)
STR = %GET_NAME(TARGET)%

@GET_CFLAG(ARG:0, ARG:1)
#FUNCTION
  SIF ARG:0 &lt;= 0 || ARG:0 &gt;= CHARANUM
    RETURNF 0
  RETURNF CFLAG:(ARG:0):(ARG:1)

@GET_NAME(ARG:0)
#FUNCTIONS
  SIF ARG:0 &lt;= 0 || ARG:0 &gt;= CHARANUM
    RETURNF &quot;&quot;
  RETURNF NAME:(ARG:0)
</code></pre></div><p>函数定义的参数用<code>()</code>括起来，但这不是定义的必要语法。</p><p>如果你想在表达式中调用一个函数，你需要使用带<code>()</code>的语法。</p><p>你也可以用逗号把函数名和参数分开，就像你对普通函数那样。</p><p>下面两行的意思是一样的：</p><div class="language-"><pre><code>@GET_CFLAG(ARG:0, ARG:1)
@GET_CFLAG, ARG, ARG:1
</code></pre></div><p>也可以为参数设置初始值。</p><p>关于初始值的语法的更多信息，请参阅在你自己的<a href="./.html">函数中指定参数</a>。</p><h2 id="限制条件" tabindex="-1">限制条件 <a class="header-anchor" href="#限制条件" aria-hidden="true">#</a></h2><h3 id="不能从call中调用" tabindex="-1">不能从CALL中调用 <a class="header-anchor" href="#不能从call中调用" aria-hidden="true">#</a></h3><p>带有<code>FUNCTION(S)</code>标志的函数不能以通常的方式调用，例如<code>CALL</code>。</p><p>它只能在一个表达式中被调用。</p><div class="language-"><pre><code>;错误
CALL GET_CFLAG, X, Y

@GET_CFLAG(ARG:0, ARG:1)
#FUNCTION
  SIF ARG:0 &lt;= 0 || ARG:0 &gt;= CHARANUM
    RETURNF 0
  RETURNF CFLAG:(ARG:0):(ARG:1)
</code></pre></div><p><code>#FUNCTION(S)</code>可以从<code>CALLF</code>和<code>CALLFORMF</code>中调用，它们是调用<code>FUNCTION(S)</code>的专用指令。</p><h3 id="有些指令是不可用的" tabindex="-1">有些指令是不可用的 <a class="header-anchor" href="#有些指令是不可用的" aria-hidden="true">#</a></h3><p>在带有<code>FUNCTION(S)</code>标志的函数中，不允许有输入的命令，如<code>WAIT</code>，和带有函数调用的命令，如<code>CALL</code>。</p><p>如果使用它们，就会发生错误。</p><p>不能使用<code>CALL</code>指令，但可以在表达式中调用带有<code>FUNCTION(S)</code>标志的函数。</p><p>也可以用<code>CALLF</code>和<code>CALLFORMF</code>指令调用<code>#FUNCTION(S)</code>。</p><h3 id="不支持函数重载" tabindex="-1">不支持函数重载 <a class="header-anchor" href="#不支持函数重载" aria-hidden="true">#</a></h3><p>不可能用不同数量或类型的参数调用一个以上的<code>#FUNCTION(S)</code>函数。</p><p>只能定义一个同名的函数，如果定义了多个同名的函数，只有第一个函数是有效的。</p><h3 id="覆盖内置函数" tabindex="-1">覆盖内置函数 <a class="header-anchor" href="#覆盖内置函数" aria-hidden="true">#</a></h3><p>如果你定义了一个与内置函数同名的函数，你将无法调用该内置函数。</p><p>例如，如果你定义了<code>@ABS</code>，你将无法调用原来的<code>ABS</code>。</p><p>如果一个内置函数被覆盖，Emuera 将在启动时显示一个警告。</p><p>如果一个内置函数被覆盖，它可能无法按预期工作，所以可以通过配置来禁止函数的覆盖。</p><p>对于故意覆盖的情况（不推荐），也有一个配置选项，如果一个函数被覆盖，则不发出警告。</p><h2 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-hidden="true">#</a></h2><p>带有<code>FUNCTION(S)</code>标志的函数不应该改变除局部变量以外的任何变量。</p><p>改变非局部变量的函数（有副作用的函数）可能会由于短路评估或表达式评估的顺序而改变其行为，如下所述。</p><p>对这些函数的意外调用，例如从调试命令或从调试变量观察窗口，也可能导致非预期的行为。</p><h3 id="短路逻辑导致调用省略" tabindex="-1">短路逻辑导致调用省略 <a class="header-anchor" href="#短路逻辑导致调用省略" aria-hidden="true">#</a></h3><p>即使表达式中存在一个函数，也可能由于短路逻辑而无法调用。</p><p>例如，下面的脚本在<code>IF</code>语句中调用<code>GET_ASSI_CFLAG</code>，并改变<code>GET_ASSI_CFLAG</code>中的<code>ASSI</code>。</p><div class="language-"><pre><code>IF X || GET_ASSI_CFLAG(0)
  Y = CFLAG:ASSI:2
ENDIF

@GET_ASSI_CFLAG(ARG:0)
#FUNCTION
  SIF ASSI &lt; 0
    ASSI = 0
  RETURNF CFLAG:ASSI:(ARG:0)
</code></pre></div><p>乍一看，执行<code>Y = CFLAG:ASSI:2</code>时，似乎不可能出现<code>ASSI &lt; 0</code>。</p><p>然而，如果X非零，<code>GET_ASSI_CFLAG</code>由于短路评估而不被执行，当试图评估<code>CFLAG:ASSI:2</code>而<code>ASSI &lt; 0</code>时可能发生错误。</p><h3 id="其结果取决于方程的评估顺序" tabindex="-1">其结果取决于方程的评估顺序 <a class="header-anchor" href="#其结果取决于方程的评估顺序" aria-hidden="true">#</a></h3><p>变量和函数在表达式中被评估的顺序是未定义的。</p><p>有副作用的函数可能取决于表达式中的函数被调用的顺序。</p><p>请不要写这样的代码。</p><p>对于同一版本的 Emuera，调用顺序将是相同的，但在未来可能会发生变化。</p><p>在下面的脚本中，<code>TARGET</code>在<code>ADDCHARA_CFLAG</code>中被改变：</p><div class="language-"><pre><code>X = CFLAG:TARGET:10 + ADDCHARA_CFLAG(0)

@ADDCHARA_CFLAG(ARG)
#FUNCTION
  ADDCHARA ARG
  TARGET = CHARANUM -1
  RETURNF CFLAG:TARGET:2
</code></pre></div><p>根据<code>CFLAG:TARGET:10</code>是在<code>ADDCHARA_CFLAG</code>之前还是之后被评估，<code>CFLAG:TARGET:10</code>所指向的变量将会改变。</p><p>因此，这个脚本取决于评价的顺序。</p><p>你不应该在带有<code>FUNCTION(S)</code>标志的函数中赋值给<code>ADDCHARA</code>或<code>TARGET</code>。</p><h3 id="可由调试函数调用" tabindex="-1">可由调试函数调用 <a class="header-anchor" href="#可由调试函数调用" aria-hidden="true">#</a></h3><p><code>FUNCTION(S)</code>标记的函数不仅可以被<code>*.ERB</code>文件中的脚本动态调用，还可以被调试命令和调试变量观察窗口调用。</p><p>特别是，变量<code>watch</code>将试图频繁地更新其值，并在每次更新时调用该函数。</p><p>有副作用的功能可能会因为这种调用而发生故障。</p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"contribute_documentation_standard.md\":\"dc4b5f05\",\"contribute_index.md\":\"593eb63a\",\"ecosystem_index.md\":\"a75d2330\",\"guide_history.md\":\"cdbb8fd4\",\"guide_quick_start.md\":\"12588b55\",\"guide_index.md\":\"5c8ef91a\",\"guide_tutorials_io.md\":\"0abc035e\",\"guide_tutorials_type.md\":\"0a6f21c6\",\"guide_tutorials_variable.md\":\"258b0fcc\",\"guide_tutorials_index.md\":\"424920c3\",\"index.md\":\"62caa9a5\",\"reference_csv_file.md\":\"7da5b29e\",\"reference_config_file.md\":\"4cebfb73\",\"reference_erb_compound_statements.md\":\"7e56038e\",\"reference_erb_expressions.md\":\"98d487d9\",\"reference_erb_internal_process.md\":\"500be766\",\"reference_erb_statements.md\":\"25328713\",\"reference_erb_structure.md\":\"66c38709\",\"reference_erb_variables.md\":\"b93df329\",\"reference_error_index.md\":\"47374ce4\",\"reference_index.md\":\"bbb76689\",\"translation_csv_file_format.md\":\"672b1e6c\",\"translation_command.md\":\"a80ce64a\",\"translation_config.md\":\"3e1f0a2f\",\"translation_custom_expression.md\":\"ee442b36\",\"translation_custom_variable.md\":\"932c9ebf\",\"translation_debug_command.md\":\"c497c41f\",\"translation_debug_mode.md\":\"72c6dabf\",\"translation_difference.md\":\"c8a53595\",\"translation_erb_file_format.md\":\"20590b3a\",\"translation_erabasic_structure.md\":\"3b8a6b4d\",\"translation_erabasic_variables.md\":\"3bb0a87a\",\"translation_expression.md\":\"b79f1556\",\"translation_flow.md\":\"c67549f0\",\"translation_function_and_preprocessor.md\":\"b0178ae0\",\"translation_general.md\":\"d7a51ecd\",\"translation_glossary.md\":\"eb15d7d8\",\"translation_html_print.md\":\"2f534cff\",\"translation_header_file.md\":\"82c9660c\",\"translation_operator.md\":\"5d3a26db\",\"translation_replace_csv.md\":\"7a255f11\",\"translation_resource.md\":\"791af5c3\",\"translation_variable.md\":\"5ffa6dc3\",\"translation_index.md\":\"ac0cbac6\"}")</script>
    <script type="module" async src="/Era-Chinese-Documentation/assets/app.0c072424.js"></script>
    
  </body>
</html>